\section{Partial Order-Restriction Consistency}
\label{ch:por:sect:pordef}
In this section we introduce \PRCNF\ (or short, \PRCN), a novel consistency model that allows
the developer to reason about various consistency requirements in a single
system. The key intuition behind our proposal is that this model is generic and 
can be perceived as a set of restrictions imposed over admissible partial orders 
across the operations of a replicated system.

\subsection{Defining \PRCN}
We formulate \PRCN\ by following the same methodology we used for \RBCN\ (Seen in Chapter~\ref{chapter:redblue}).
The definition of \PRCN\ includes three important components: (1) a set of restrictions, which
specifies the visibility relations between pair-wise operations; (2) a Restricted Partial order (or short, R-Order), which
establishes a (global) partial order of operations respecting operation visibility relations; and (3) a set of site-specific causal serializations,
which corresponds to total orders in which the operations are locally applied. We define
these components formally as follows:

\begin{mydef}
\textbf{Restriction: } Given a set of operations $U$, a restriction is a symmetric binary relation on $U\times U$
\footnote{This definition is analogous to the conflict relation in Generic Broadcast~\cite{Pedone99genericbroadcast}.}.
\label{def:restr}
\end{mydef}

For any two operations $u$ and $v$ in $U$, if there exists a restriction relation $r(u, v)$, 
then they must be ordered in any partial order $\prec$, i.e., $u\prec v \vee v\prec u$. We capture this point
in the following definition.

\begin{mydef}
\textbf{Restricted Partial Order (or short, R-Order): } Given a
set of operations $U$, and a set of restrictions $R$ over $U$, an R-Order is a partial order
$O = (U, \prec)$ with the following constraint: $\forall u, v\in U,$ $r(u, v)\in R$ $\implies u\prec v\vee v\prec u$.
\label{def:rorder}
\end{mydef}

We also say that restrictions in $R$ are met in the corresponding R-Order if this order
satisfies the above definition. Similar to \RBCN, every site (replica) executes operations following a linear
extension of the global R-Order. The following definition defines what linear extensions are allowed with respect to
a given R-Order.

\begin{mydef}
\textbf{Legal serialization: } $O' = (U, <)$ is a legal serialization of R-Order $O = (U, \prec)$
if $O'$ is a linear extension of $O$; i.e., $<$ is a total order compatible with the partial order defined by $\prec$.
\label{def:legalserial}
\end{mydef}

As introduced in Chapter~\ref{chapter:redblue}, our proposal of splitting operations into pairs of generator and shadow
operations changes the traditional state machine replication definitions. In this work, we also embrace
the shadow operation concept so that we can reduce the number of required restrictions for ensuring
state convergence. With this change,
when user requests are accepted by any site, that site executes their generator operations and 
creates corresponding shadow operations. In addition, every site also 
incorporates remote shadow operations that are shipped from all other sites into its local serialization. 
We denote $U$ a set of shadow operations. For a site $i$,
its generator operation set is denoted by $V_{i}$. The following definition captures the application
of both local and remote shadow operations at a site $i$.


\begin{mydef}
\textbf{Causal legal serialization: } Given a site $i$, a R-Order $O=(U, \prec)$ and the set of generator operations $V_i$ received at site $i$, we say that $O_i = (U\cup V_{i}, <_i)$ is an i-causal legal serialization (or short, a
causal serialization) of $O$ if
\begin{itemize}
\item $O_i$ is a total order;
\item $(U,<_i)$ is a legal serialization of $O$;
\item For any $h_v(S)\in U$ generated by $g_v\in V_i$, $S$ is the
  state obtained after applying the sequence of
  shadow operations preceding $g_v$ in $O_i$;
\item For any $g_v\in V_i$ and $h_u(S) \in U$, $h_u(S)<_{i}g_v$ in $O_i$
  iff $h_u(S) \prec h_v(S')$ in $O$.
\end{itemize}
\label{def:causalserial}
\end{mydef}

%Since generator operations have no side effects, in order to make proofs easy to follow, we simplify $O_i = (U\cup V_{i}, <_i)$ to $O'_i = (U, <_i)$ by removing generator operations in $V_{i}$ from $O_i$. If $O_i = (U\cup V_{i}, <_i)$ is an $i$-causal serialization of a R-Order $O$, then
%the simplified version $O'_i = (U, <_i)$ is too.

A replicated system with $k$ sites is then \PRCAJ\ if every site applies a
causal serialization of the same global R-Order $O$.

\begin{mydef}
\textbf{\PRCNF\ (or short, \PRCN):} A replicated system $\mathscr{S}$ with a set of restrictions $R$ is \PRCAJ\ if 
each site $i$ applies shadow operations according to an $i$-causal serialization of R-Order $O$.
\label{def:porconsistency}
\end{mydef}


\subsection{Expressiveness} The intuition behind the \PRCN\ model is that the model can be viewed as a
parametrized function, which takes restrictions as input, and outputs
a particular consistency model where the restrictions must be met in any partial order.
To demonstrate the power of \PRCN,
we use it to express many different consistency requirements. 
For causal consistency~\cite{Lloyd2011Causal} (excluding any restrictions to provide session guarantees), 
the restriction set is empty, since causality is already preserved in the definition 
of \PRCN\ by having $u \prec v \wedge v \prec w \implies u < w$. 
Regarding \RBCN, to capture the notion of strongly consistent (red) operations, we define 
the following restriction set: for any pair of operations $u$, $v$, if $u$ and $v$ are strongly consistent, 
we have $r(u,v)$. Serializability~\cite{Bernstein1987CCR} totally orders all
operations, so its restriction set is as follows: for any pair of operations $u$, $v$, we have $r(u, v)$.
